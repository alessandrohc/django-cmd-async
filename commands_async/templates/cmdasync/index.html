{% extends "cmdasync/base.html" %}
{% load staticfiles %}

{% block title %}Run tasks{% endblock %}

{% block extrahead %}
       <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="{% static "cmdasync/styles.css" %}">
    <script type="application/javascript" src="{% static "cmdasync/js/cmdhandler.js" %}"></script>
    <script type="application/javascript">
        $(document).ready(function () {
            cmdayncform.init("#taskOutput");

            $(".dropdown-menu > li > a").on('click', function () {
                var value = $(this).attr("href");
                value = value.substring(1, value.length);

                var items = value.split(".");
                var app_command = items[items.length-1];
                var app_name = items.slice(0, -1).join(".").toUpperCase();

                $("#form-app_name").html(app_name);
                $("#dropdownTaskMenu").find("> span.info").html(app_command);
                $("input#id_app_command").val(value);
                // stop status update
                cmdayncform.update_abort();
                cmdayncform.clear_output();
            });

            cmdayncform.ajax("form#taskform", {
                beforeSubmit: function(arr, $form, options) {
                    var $button = $form.find('button[type=submit]');
                    if ($button.hasClass('disabled'))
                        return false;
                    $button.addClass('disabled');

                    var $btnCancel = $("#btn-form-cancel");
                    $btnCancel.removeClass('disabled');
                    $btnCancel.click(function() {
                        cmdayncform.update_abort();
                        $(this).addClass('disabled');
                    });

                    var $btnRevoke = $("#btn-form-revoke");
                    $btnRevoke.removeClass('disabled');
                    $btnRevoke.click(cmdayncform.revoke_task.bind(cmdayncform));
                }
            });

            cmdayncform.add_ajax_update_finish(function(form) {
                var $button = form.find('button[type=submit]');
                $button.removeClass('disabled');
                var $btnCancel = $("#btn-form-cancel");
                $btnCancel.addClass('disabled');
                $btnCancel.unbind("click"); // avoid stack grow
                var $btnRevoke = $("#btn-form-revoke");
                $btnRevoke.addClass('disabled');
                $btnRevoke.unbind("click");
            })
        });
    </script>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="panel panel-default {% if form.errors %}panel-danger{% else %}panel-success{% endif %}">
        {% if form.errors %}<div class="panel-heading">{{ form.errors }}</div>{% endif %}
        <div class="panel-body">
            <form class="navbar-form navbar-left" id="taskform" action="." method="post">{% csrf_token %}
                <div class="form-group">
                    <div class="btn-group" role="group">
                        <div class="btn-group" role="group">
                            <div class="input-group">
                                <span class="input-group-addon">
                                    <input type="checkbox" aria-label="realtime">
                                </span>
                                <span class="input-group-addon" id="form-app_name">CELERY</span>
                                {% include "cmdasync/form-dropdown.html" %}
                            </div>

                        </div>
                        {{ form.as_ul }}
                        <button type="submit" class="btn btn-default btn-md">Execute</button>
                        <input type="button" id="btn-form-cancel" class="btn btn-warning btn-md disabled" value="Cancel">
                        <input type="button" id="btn-form-revoke" class="btn btn-danger btn-md disabled" value="Revoke">
                    </div>
                </div>
            </form>
        </div>
        <div class="panel-footer">
            <div class="well-lg">
                <pre id="taskOutput">OUTPUT</pre>
            </div>
        </div>
    </div>
</div>
{{ body.super }}
{% endblock %}