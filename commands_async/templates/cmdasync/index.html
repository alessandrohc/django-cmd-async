{% extends "cmdasync/base.html" %}
{% load staticfiles %}

{% block title %}Run tasks{% endblock %}

{% block extrahead %}
       <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="{% static "cmdasync/styles.css" %}">
    <script type="application/javascript" src="{% static "cmdasync/js/cmdhandler.js" %}"></script>
    <script type="application/javascript">
        $(document).ready(function () {
            cmdasyncform.init("#taskOutput");

            var rel_inputs = {
                'args': 'task-args',
                'kwargs': 'task-kwargs',
                'app_command': 'task-app-command'
            };

            // passing parameters.
            $("#task-args").change(function(){ $("#id_args").val($(this).val());});
            $("#task-kwargs").change(function(){ $("#id_kwargs").val($(this).val());});

            {% if settings.COMMANDS_ASYNC_LIST %}
            $(".dropdown-menu > li > a").on('click', function () {
                var value = $(this).attr("href");
                value = value.substring(1, value.length);

                var items = value.split(".");
                var app_command = items[items.length-1];
                var app_name = items.slice(0, -1).join(".").toUpperCase();

                $("#form-app_name").html(app_name);
                $("#task-app-command").find("> span.info").html(app_command);

                $("input#id_app_command").val(value);
                // stop status update
                cmdasyncform.update_abort();
                cmdasyncform.clear_output();
            });
            {% else %}
            $("#task-submit").click(function(){
                $("#id_app_command").val($("#task-app-command").val());
            });
            {% endif %}

            var requestErrorClean = function() {
                var $panel = $("#task-panel");
                $panel.removeClass('panel-danger');
                $panel.find('.panel-heading').hide();
                $("#task-error-header").remove();
                for (var name in rel_inputs) {
                    $("#" + rel_inputs[name]).parent().removeClass("has-error");
                }
            };

            var requestUpdateFinish = function() {
                $("#task-progress").hide();
                var $btnSubmit = $('#task-submit');
                $btnSubmit.removeClass('disabled');
                var $btnCancel = $("#btn-form-cancel");
                $btnCancel.addClass('disabled');
                $btnCancel.unbind("click"); // avoid stack grow
                var $btnRevoke = $("#btn-form-revoke");
                $btnRevoke.addClass('disabled');
                $btnRevoke.unbind("click");
            };

            cmdasyncform.ajax("form#taskform", {
                beforeSubmit: function(arr, $form, options) {
                    var $button = $form.find('button[type=submit]');
                    if ($button.hasClass('disabled'))
                        return false;
                    $button.addClass('disabled');

                    var $btnCancel = $("#btn-form-cancel");
                    $btnCancel.removeClass('disabled');
                    $btnCancel.click(function() {
                        cmdasyncform.update_abort();
                        $(this).addClass('disabled');
                    });

                    var $btnRevoke = $("#btn-form-revoke");
                    $btnRevoke.removeClass('disabled');
                    $btnRevoke.click(cmdasyncform.revoke_task.bind(cmdasyncform));
                },
                error: function(xhr) {
                    requestErrorClean();
                    if (xhr.status === 400) {
                        var data = xhr.responseJSON;
                        var $input, $inputParent;
                        var $panel = $("#task-panel");
                        $panel.addClass("panel-danger");
                        var $header = $panel.find('.panel-heading').hide();
                        var $errorGroup = $("<ul id='task-error-header'></ul>");
                        for (var name in data.form.errors) {
                            $input = $("#" + rel_inputs[name]);
                            $inputParent = $input.parent();
                            $inputParent.addClass("has-error has-feedback");
                            $errorGroup.append("<li class='.error help-block'>" + data.form.errors[name][0] + "</li>");
                        }
                        $header.append($errorGroup);
                        $header.show();
                    }
                    requestUpdateFinish();
                }
            });
            cmdasyncform.add_event_callback("updating", function($form) {
                var count = $form.data("count") + 1;
                var $progress = $("#task-progress");
                $progress.find("div.progress-bar")
                    .css("width", count + "%")
                    .attr('aria-valuenow', count);
                $progress.show();
                if (count > 100) count = 0;
                $form.data("count", count);
            });
            cmdasyncform.add_event_callback("form-valid",
                function(responseText, statusText, xhr, $form) {
                $form.data("count", 0);
                requestErrorClean();
            });

            cmdasyncform.add_event_callback("update-finish",
                function(form) {
                requestUpdateFinish();
            })
        });
    </script>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="panel panel-default" id="task-panel">
        <div class="panel-heading" style="display: none"></div>
        <div class="panel-body">
            <form class="navbar-form navbar-left" id="taskform" action="." method="post">{% csrf_token %}
                <div class="form-group">
                    <div class="input-group">
                        {% if settings.COMMANDS_ASYNC_LIST %}
                            <span class="input-group-addon" id="form-app_name">CELERY</span>
                            {% include "cmdasync/form-dropdown.html" %}
                        {% else %}
                            <span class="input-group-addon" id="form-app_name">COMMAND</span>
                            <input type="text" id="task-app-command" class="form-control"
                                   autocomplete="on" placeholder=""
                                   aria-describedby="basic-addon2">
                        {% endif %}
                    </div>
                    <div class="btn-group" role="group">
                        {{ form.as_ul }}
                        <button type="submit" id="task-submit" class="btn btn-default btn-md">Execute</button>
                        <input type="button" id="btn-form-cancel" class="btn btn-warning btn-md disabled" value="Cancel">
                        <input type="button" id="btn-form-revoke" class="btn btn-danger btn-md disabled" value="Revoke">
                    </div>
                    <div class="btn-group" role="group">
                        <div class="input-group ">
                            <span class="input-group-addon" id="basic-addon2">args</span>
                            <input type="text" id="task-args" class="form-control" autocomplete="off" placeholder="Insert arguments"
                                   aria-describedby="basic-addon2">
                        </div>
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon2">kwargs</span>
                            <input type="text" id="task-kwargs" class="form-control" autocomplete="off" placeholder="Insert arguments"
                                   aria-describedby="basic-addon2">
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="panel-footer">
            <div class="progress" id="task-progress" style="display: none">
              <div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar"
                   aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <span class="sr-only"></span>
              </div>
            </div>
            <div class="well-lg">
                <pre id="taskOutput"></pre>
            </div>
        </div>
    </div>
</div>
{{ body.super }}
{% endblock %}