{% extends "cmdasync/base.html" %}
{% load staticfiles %}

{% block title %}Run tasks{% endblock %}

{% block extrahead %}
       <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="{% static "cmdasync/styles.css" %}">
    <script type="application/javascript" src="{% static "cmdasync/js/cmdhandler.js" %}"></script>
    <script type="application/javascript">
        $(document).ready(function () {
            cmdayncform.init("#taskOutput");

            $(".dropdown-menu > li > a").on('click', function () {
                var value = $(this).attr("href");
                $("#dropdownTaskMenu").find("> span.info").html(value);
                $("input#id_app_command").val(value);
                // stop status update
                cmdayncform.update_abort();
                cmdayncform.clear_output();
            });

            cmdayncform.ajax("form#taskform", {
                beforeSubmit: function(arr, $form, options) {
                    var form = $("form#taskform");
                    var $button = form.find('button[type=submit]');
                    $button.addClass('disabled')
                }
            });

            cmdayncform.add_ajax_update_finish(function(){
                var form = $("form#taskform");
                var $button = form.find('button[type=submit]');
                $button.removeClass('disabled')
            })
        });
    </script>
{% endblock %}

{% block body %}
<div class="container">
    <div class="panel panel-default {% if form.errors %}panel-danger{% else %}panel-success{% endif %}">
        {% if form.errors %}<div class="panel-heading">{{ form.errors }}</div>{% endif %}
        <div class="panel-body">
            <form class="navbar-form navbar-left" id="taskform" action="." method="post">{% csrf_token %}
                <div class="form-group">
                    <div class="dropdown">
                        <button class="btn btn-default btn-sm dropdown-toggle"
                                type="button"
                                id="dropdownTaskMenu"
                                data-toggle="dropdown"
                                aria-haspopup="true"
                                aria-expanded="true">
                            <span class="info">Choose one</span>
                            <span class="glyphicon glyphicon-menu-down"></span>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownTaskMenu">
                        {% for app_name, values in commands.items %}
                            <li class="dropdown-header">{{ app_name|upper }}</li>
                            {% for cmd in values %}
                                <li><a href="#{{ app_name }}.{{ cmd }}">{{ cmd|lower }}</a></li>
                            {% endfor %}
                            <li role="separator" class="divider"></li>
                        {% endfor %}
                        </ul>
                    </div>
                    {{ form.as_ul }}
                </div>
                <button type="submit" class="btn btn-default">Execute</button>
            </form>
        </div>
        <div class="panel-footer">
            <pre id="taskOutput">OUTPUT</pre>
        </div>
    </div>
</div>
{{ body.super }}
{% endblock %}